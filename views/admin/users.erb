<h1 class="dcf-txt-h3">Manage Users <span class="dcf-subhead"><a id="show-toolbox" href="#">Show Toolbox</a></span></h1>

<div id="toolbox" class="toolbox" style="display: none;">
    <h2 class="dcf-txt-h3">Toolbox <span class="dcf-float-right"><a style="color: white;" href="#" id="hide-toolbox">&ndash;</a></span></h2>
    <div class="tools">
        <a class="dcf-mt-1 dcf-btn dcf-btn-primary" href="/admin/users/create/">Create User</a>
        <a class="dcf-mt-1 dcf-btn dcf-btn-primary" href="/admin/users/<%= @user.id %>/edit/">Edit My User</a>
        <a class="dcf-mt-1 dcf-btn dcf-btn-secondary" href="/admin/users/<%= @user.id %>/manage/">My Tools</a>
        <a class="dcf-mt-1 dcf-btn dcf-btn-secondary" href="/admin/users/download/">Download User Data</a>
    </div>
</div>

<form class="dcf-form dcf-mb-6" id="find-controls">
    <div class="dcf-grid dcf-col-gap-vw dcf-row-gap-6">
        <div class="dcf-col-100% dcf-col-25%-start@md">
            <label>Find users by:</label>
            <br>
            <a href="/admin/users/" class="dcf-btn dcf-btn-secondary">Clear</a>
        </div>
        <div class="dcf-col-100% dcf-col-75%-end@md">
            <div class="dcf-grid-full dcf-grid-halves@sm dcf-col-gap-vw">
                <div>
                    <label for="first-name">First Name:</label>
                    <input id="first-name" type="text" name="first_name" value="<%= first_name != "" ? first_name : "" %>" style="width:100%;" />
                </div>
                <div>
                    <label for="last-name">Last Name:</label>
                    <input id="last-name" type="text" name="last_name" value="<%= last_name != "" ? last_name : "" %>" style="width:100%;" />
                </div>
                <div>
                    <label for="email">Email:</label>
                    <input id="email" type="text" name="email" value="<%= email != "" ? email : "" %>" style="width:100%;" />
                </div>
                <div>
                    <label for="studio-status">Studio Status:</label>
                    <select id="studio-status" name="studio_status" class="dcf-input-select">
                        <option value=""></option>
                        <% USER_STATII.each do |word| %>
                            <option <%= 'selected="selected"' if studio_status == word %> value="<%= word %>"><%= word %></option>
                        <% end %>
                    </select>
                </div>
                <div>
                    <label for="tool-authorization">Tool Authorization:</label>
                    <select id="tool-authorization" name="tool_authorization" class="dcf-input-select">
                        <option value=""></option>
                        <% tools.each do |tool| %>
                            <option <%= 'selected="selected"' if tool_authorization.to_i == tool.id %> value="<%= tool.id %>"><%= tool.name %></option>
                        <% end %>
                    </select>
                </div>
                <div>
                    <label for="expiration-date">Expiration Date:</label>
                    <div class="dcf-grid dcf-col-gap-1 dcf-row-gap-2 dcf-flex-wrap">
                        <div class="dcf-col-100% dcf-col-33%-start@sm">
                            <select id="expiration-date-operation" name="expiration_date_operation" class="dcf-input-select">
                                <option value=""></option>
                                <% EXPIRATION_DATE_SEARCH_OPERATIONS.each_with_index do |operation, value| %>
                                    <option <%= 'selected="selected"' if expiration_date_operation.to_i == (value + 1) %> value="<%= value + 1 %>"><%= operation %></option>
                                <% end %>
                            </select>
                        </div>
                        <div class="dcf-col-100% dcf-col-67%-end@sm">
                            <div class="dcf-datepicker">
                                <input id="start-date" value="<%= expiration_date != "" ? expiration_date : "" %>" name="expiration_date" title="Expiration Date" type="text"  style="width:100%;"/>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
            <button id="search-btn" class="dcf-btn dcf-btn-inverse-primary" style="margin-top:10px;">Search</button>
        </div>
    </div>
</form>

<% if users.count > 0 %>
<div>
    <table class="dcf-w-100% dcf-table dcf-table-bordered dcf-table-responsive" aria-label="Users List">
        <thead>
            <tr>
                <th scope="col" style="max-width: 80px;">Image</th>
                <th scope="col">Name</th>
                <th scope="col">Username</th>
                <th scope="col">Email</th>
                <th scope="col">Tool Authorizations</th>
                <th scope="col">Expiration Date</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody>
        <% users.each do |user| %>
            <tr>
                <td style="max-width: 80px;">
                    <% if user.imagedata %>
                    <img src="<%= user.image_src %>" alt="Image for User: <%= user.username %>">
                    <% end %>
                </td>
                <td>
                    <%= user.full_name %><br>
                    <span class="dcf-txt-sm"><%= user.university_status %></span>
                </td>
                <td>
                    <%= user.username %>
                </td>
                <td>
                    <%= user.email %>
                </td>
                <td>
                    <% if user.authorized_resource_ids.count == 0 %>
                        None
                    <% else %>
                        <%= user.resource_authorizations.map(&:resource).map(&:name).first(5).join('<br>') %>
                        <% if user.authorized_resource_ids.count > 5 %>
                        <br><a href="/admin/users/<%= user.id %>/manage/">... and <%= user.authorized_resource_ids.count - 5 %> more</a>
                        <% end %>
                    <% end %>
                </td>
                <td>
                <%= user.expiration_date.strftime('%m/%d/%Y') if user.expiration_date %>
                </td>
                <td class="table-actions">
                    <a href="/admin/users/<%= user.id %>/edit/" class="dcf-mt-1 dcf-btn dcf-btn-primary">Edit</a>
                    <a href="/admin/users/<%= user.id %>/manage/" class="dcf-mt-1 dcf-btn dcf-btn-secondary">Tools</a>
                    <form class="dcf-form delete-form delete-user" action="/admin/users/<%= user.id %>/delete/" method="POST">
                        <button type="submit" class="dcf-mt-1 dcf-btn dcf-btn-primary">Delete</button>
                    </form>
                </td>
            </tr>
        <% end %>
        </tbody>
    </table>
</div>
<% else %>
<br>
<label>No users meet this criteria, or you have not created any. Open the toolbox to get started.</label>
<% end %>

<% append_script_declaration("WDN.initializePlugin('datepickers');") %>

<% append_script_declaration(%q[require(['jquery'], function($) {
    $(document).ready(function() {
        $('.delete-user').submit(function (submit) {
            if (!window.confirm('Are you sure you want to delete this user?')) {
                submit.preventDefault();
            }
        });
        $('#show-toolbox').click(function (click) {
            click.preventDefault();
            $('#show-toolbox').hide();
            $('#toolbox').slideDown();
        });
        $('#hide-toolbox').click(function (click) {
            click.preventDefault();
            $('#toolbox').slideUp(400, function () {
                $('#show-toolbox').show();
            });
        });
    });
});]) %>